#!/bin/bash
set -euo pipefail

# Dossiers / chemins
GAMEDIR="${GAMEDIR:-/opt/sandstorm}"
CFGDIR="${GAMEDIR}/Insurgency/Saved/Config/LinuxServer"
GAMEINI="${CFGDIR}/Game.ini"
MAPCYCLE="${GAMEDIR}/Insurgency/Config/Server/MapCycle.txt"
STEAMCMDDIR="${STEAMCMDDIR:-/home/steam/steamcmd}"
APPID="${APPID:-581330}"

# Valeurs par dÃ©faut
: "${AUTO_UPDATE:=1}"
: "${PORT:=27102}"
: "${QUERYPORT:=27131}"
: "${BEACONPORT:=15000}"
: "${RCON_PASSWORD:=ChangeMe!}"
: "${SS_HOSTNAME:=Chourmovs ISS}"
: "${SS_MAXPLAYERS:=16}"

# Map / mode
: "${SS_MAP:=Farmhouse}"
: "${SS_SCENARIO:=Scenario_Farmhouse_Checkpoint_Security}"
: "${SS_GAME_MODE:=Checkpoint}"

# Bots etc. (tes variables dÃ©jÃ  dÃ©finies plus loin, inchangÃ©es)

echo "â–¶ï¸ Starting Insurgency Sandstorm Dedicated Server...

  PORT=${PORT} | QUERYPORT=${QUERYPORT} | BEACONPORT=${BEACONPORT}
  RCON_PASSWORD=******** | AUTO_UPDATE=${AUTO_UPDATE}
  MAP=${SS_MAP} | SCENARIO=${SS_SCENARIO} | MODE=${SS_GAME_MODE}
"

# â”€â”€ CrÃ©ation robuste des dossiers nÃ©cessaires (avec messages utiles)
need_paths=(
  "${GAMEDIR}"
  "${GAMEDIR}/Insurgency"
  "${GAMEDIR}/Insurgency/Saved"
  "${GAMEDIR}/Insurgency/Saved/SaveGames"
  "${GAMEDIR}/Insurgency/Config/Server"
  "${CFGDIR}"
)

for p in "${need_paths[@]}"; do
  if [ ! -d "$p" ]; then
    if mkdir -p "$p" 2>/dev/null; then
      :
    else
      echo "âŒ Permission refusÃ©e pour crÃ©er: $p"
      echo "   âžœ VÃ©rifie que le volume est possÃ©dÃ© par uid:gid 1000:1000."
      echo "   âžœ Astuce: exÃ©cute le service 'fixperms' (voir stack) ou la commande one-shot chown."
      sleep 3
      exit 1
    fi
  fi
done

# SÃ©curitÃ©: refuser de continuer si on ne peut pas Ã©crire
echo "write-test" > "${GAMEDIR}/.writetest" 2>/dev/null || {
  echo "âŒ Impossible d'Ã©crire dans ${GAMEDIR} (problÃ¨me de permissions)."
  echo "   âžœ Corrige les droits (chown -R 1000:1000) puis relance."
  exit 1
}
rm -f "${GAMEDIR}/.writetest"

# â”€â”€ Auto-update SteamCMD (avec retries anti-0x602)
if [ "${AUTO_UPDATE}" = "1" ]; then
  echo "ðŸ“¥ Updating server via SteamCMD..."
  tries=4
  i=1
  while [ $i -le $tries ]; do
    if "${STEAMCMDDIR}/steamcmd.sh" +@sSteamCmdForcePlatformType linux \
        +force_install_dir "${GAMEDIR}" \
        +login anonymous \
        +app_update "${APPID}" validate \
        +quit; then
      break
    fi
    echo "âš ï¸  SteamCMD validate failed (try $i/${tries}). Retrying without validate..."
    if "${STEAMCMDDIR}/steamcmd.sh" +@sSteamCmdForcePlatformType linux \
        +force_install_dir "${GAMEDIR}" \
        +login anonymous \
        +app_update "${APPID}" \
        +quit; then
      break
    fi
    if [ $i -eq $tries ]; then
      echo "âŒ SteamCMD update failed after ${tries} tries â€” I will continue if the server files already exist."
      break
    fi
    sleep 5
    i=$((i+1))
  done
fi

# â”€â”€ Ã€ partir dâ€™ici, garde le reste de TON script (Ã©criture MapCycle, Game.ini, lancement)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (B) GÃ©nÃ©ration MapCycle.txt
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SS_MAPCYCLE peut Ãªtre une ou plusieurs lignes "Scenario_XXX"
# Ex: 
#   SS_MAPCYCLE="Scenario_Farmhouse_Checkpoint_Security
#   Scenario_Summit_Checkpoint_Security"
echo "ðŸ—ºï¸  Writing MapCycle..."
{
  # PremiÃ¨re ligne: "MapCycle=..."
  echo "# Generated by entrypoint"
  echo "# One scenario id per line is supported by Sandstorm dedicated"
  echo "${SS_MAPCYCLE}" | tr '\r' '\n' | sed '/^\s*$/d'
} > "${MAPCYCLE}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (C) GÃ©nÃ©ration Game.ini orientÃ© CHECKPOINT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ðŸ§© Writing Game.ini..."
cat > "${GAMEINI}" <<EOF
; ------------------------------------------------------------------
; Insurgency Sandstorm - Game.ini (orientÃ© COOP / CHECKPOINT)
; NOTE: Lancer un scÃ©nario Checkpoint (ex: Scenario_Farmhouse_Checkpoint_Security)
;       pour que ces paramÃ¨tres s'appliquent.
; ------------------------------------------------------------------

[/Script/Insurgency.INSGameMode]
; ===== QOL gÃ©nÃ©rique =====
bKillFeed=${SS_KILL_FEED}
bKillCamera=${SS_KILL_CAMERA}
bVoiceEnabled=${SS_VOICE_ENABLED}

; Friendly fire global (plutÃ´t PVP ; en coop souvent ignorÃ© selon le mode)
; On force la dÃ©sactivation explicite comme demandÃ© :
bAllowFriendlyFire=${SS_ALLOW_FF:-False}
; Ã‰chelle de dÃ©gÃ¢ts FF si jamais activÃ© cÃ´tÃ© serveur / autre mode :
FriendlyFireDamageScale=${SS_FRIENDLY_FIRE_SCALE:-0.0}

; Timings et limites
GameStartingIntermissionTime=${SS_INTERMISSION_TIME:-10}
RoundLimit=${SS_ROUND_LIMIT:-1}
RoundTime=${SS_ROUND_TIME}
PostRoundTime=${SS_POST_ROUND_TIME}

; ===== NE RIEN DÃ‰FINIR ICI sur les bots pour CHECKPOINT =====
; (NumBots, BotQuota, BotDifficulty laissÃ©s absents pour Ã©viter les conflits)

[/Script/Insurgency.INSCheckpointGameMode]
; ===== ENNEMIS (COOP) =====
; IMPORTANT: pas de NumBots/BotQuota/BotDifficulty ici.
bBots=True
MinimumEnemies=${SS_MIN_ENEMIES:-20}
MaximumEnemies=${SS_MAX_ENEMIES:-20}
SoloEnemies=${SS_SOLO_ENEMIES:-0}

; Options utiles / stables en coop
bBotsUseVehicleInsertion=${SS_BOTS_USE_VEHICLE:-True}
RespawnDPR=${SS_RESPAWN_DPR:-0.5}
DefendCaptureTime=${SS_DEFEND_CAPTURE_TIME:-45}

; Supply (facultatif en coop ; mets-les si tu les utilises vraiment)
; InitialSupply=${SS_INITIAL_SUPPLY}
; MaxSupply=${SS_MAX_SUPPLY}

[/Script/Insurgency.INSCoopMode]
; ===== BOTS ALLIÃ‰S & COMPORTEMENTS =====
bKickIdleSpectators=${SS_KICK_IDLE_SPECTATORS:-True}
FriendlyBotQuota=${SS_FRIENDLY_BOT_QUOTA:-0}   ; mets 6 si tu veux des alliÃ©s

; ===== (Optionnel) Section avancÃ©e =====
; âš ï¸ Ã‰vite les mutators qui rÃ©duisent la pop (p.ex. Hardcore selon version)
; Mutators=Hardcore,NoResupply
; ObjectiveCaptureSpeedScale=1.0
; TeamKillLimit=3
; bDeadSayAll=true
EOF

echo "âœ… Game.ini Ã©crit (oriented Checkpoint). Pense Ã  redÃ©marrer le serveur."


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (D) Lancement serveur
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd "${GAMEDIR}/Insurgency/Binaries/Linux"

# Construction de la ligne de lancement
LAUNCH_MAP="${SS_MAP}?Scenario=${SS_SCENARIO}?MaxPlayers=${SS_MAXPLAYERS}"

exec ./InsurgencyServer-Linux-Shipping \
  "${LAUNCH_MAP}" \
  -hostname="${SS_HOSTNAME}" \
  -Port="${PORT}" -QueryPort="${QUERYPORT}" -BeaconPort="${BEACONPORT}" \
  -Rcon \
  -RconPassword="${RCON_PASSWORD}" \
  -log
